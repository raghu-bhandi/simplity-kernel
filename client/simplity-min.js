var POCOL={CHAR_ENCODING:"UTF-8",SERVICE_NAME:"_serviceName",USER_TOKEN:"_userToken",FILE_NAME:"_fileName",FILE_NAME_FOR_LOGS:"_logs",MIME_TYPE:"_mimeType",DISCARD_FILE:"_discard",REQUEST_STATUS:"_requestStatus",FILE_TOKEN:"_fileToken",TRACE_FIELD_NAME:"_trace",MESSAGES:"_messages",STATUS_OK:"ok",STATUS_NO_LOGIN:"noLogin",STATUS_ERROR:"error",SERVICE_EXECUTION_TIME:"_serviceExecutionTime",MESSAGE_SUCCESS:"success",MESSGAE_INFO:"info",MESSAGE_WARNING:"warning",MESSAGE_ERROR:"error",TABLE_ACTION_FIELD_NAME:"_saveAction",
TABLE_ACTION_ADD:"add",TABLE_ACTION_MODIFY:"modify",TABLE_ACTION_DELETE:"delete",TABLE_ACTION_SAVE:"save",EQUAL:"\x3d",NOT_EQUAL:"!\x3d",LESS:"\x3c",LESS_OR_EQUAL:"\x3c\x3d",GREATER:"\x3e",GREATER_OR_EQUAL:"\x3e\x3d",LIKE:"~",STARTS_WITH:"^",BETWEEN:"\x3e\x3c",IN_LIST:"@",TO_FIELD_SUFFIX:"To",COMPARATOR_SUFFIX:"Comparator",SORT_COLUMN_NAME:"_sortColumns",SORT_ORDER:"_sortOrder",SORT_ORDER_ASC:"asc",SORT_ORDER_DESC:"desc",PAGINATION_SERVICE:"_p",PAGE_SIZE_SUFFIX:"PageSize",TOTAL_COUNT_SUFFIX:"TotalCount",
PAGINATION_TABLE:"_tableName",PAGINATION_SIZE:"_pageSize",PAGINATION_PAGE_NUMBER:"_pageNumber",LIST_SERVICE_KEY:"_key",SUGGEST_STARTING:"_matchStarting",ALL_FIELDS:"_allFields",COL_MARKER:"__",IDX_MARKER:"i",DATA_TABLE:"data-table",DATA_ROW:"data-row",HAS_CHILDREN:"data-has-children",HIDE_IF_NO_DATA:"data-hide-if-no-data",LAST_JSON:"_lastJson",LOCAL_STORAGE_NAME:"_localData",LOCAL_SERVICES:"_localServices",LOCAL_RESPONSES:"_localResponses"},Simplity=function(){var D=function(b){return b&&b.replace?
b.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;"):b},p=function(b){alert("ERROR\n"+b)},J=function(b){alert("Warning\n"+b)},h=function(b,d){console.log(b)},E=function(b){alert(b)},x=function(b){b&&b.length||alert("There are no messages");for(var d=[],e=0;e<b.length;e++){var a=b[e];a.messageType&&(d.push(a.messageType.toUpperCase()),d.push("\n"));a.fieldName&&(d.push("Field : "),d.push(a.fieldName),d.push(" - "));d.push(a.text);d.push("\n\n")}E(d.join(""))},B=function(b,d){if(Array.isArray(b))h("Simplity funciton pushDataToPage() requires that the json is an object-map, but not an array. Data not pushed to page");
else{d||(d=window.document);var e;e=d.getElementsByTagName("select");for(var a=0,c={},f=e.length-1;0<=f;f--){var g=e[f],k=g.getAttribute(POCOL.DATA_TABLE);if(k){var n=c[k];n||(n=c[k]=[]);n.push(g);a++}}e=a?c:null;for(var s in b)if(0===s.indexOf("_"))h("Ignoring the reserved attribute "+s);else{a=b[s];if(null===a||Array.isArray(a)){a||(a=[]);if(c=d.getElementById(POCOL.COL_MARKER+s+POCOL.COL_MARKER)){a=a||[];f=s;g=a.length;c.style.display="none";k=c.parentNode;if(g){k.style.display="none";n=[c.outerHTML];
c.style.display="";var l=c.outerHTML.split(POCOL.COL_MARKER),r=l.length;if(1!==r%2)p("Element for table "+f+" does not follow the convention proerly. Look for pairs of "+POCOL.COL_MARKER);else{for(var t=0;t<g;t++){var u=a[t];n.push(l[0]);n.push(f+"_"+t);n.push(l[2]);for(var A=3;A<r;){var v=l[A];A++;"i"===v?n.push(t+1):u.hasOwnProperty(v)?n.push(K(u[v])):h("No value for column "+v+". cell value set to empty string");n.push(l[A]);A++}}k.innerHTML=n.join("");c.style.display="none";k.style.display=""}}else h("No data in table "+
f),k.innerHTML=c.outerHTML;continue}if((c=d.getElementById(s))&&c.getAttribute(POCOL.DATA_TABLE)){a=a||[];g=s;k=F(c);f=k.parentNode;a&&a.length?(g=L(c,g,!1),k=[],M(g,{},a,k,""),f.innerHTML=k.join(""),c.hasAttribute(POCOL.HIDE_IF_NO_DATA)&&(c.style.display="")):c.hasAttribute(POCOL.HIDE_IF_NO_DATA)?(h("No data in table "+g+" and hence we are hiding the table element"),c.style.display="none"):(h("No data in table "+g),k.style.display="none",f.innerHTML=k.outerHTML);continue}if(c=e&&e[s]){for(f=c.length-
1;0<=f;f--){g=c[f];k=a||[];l=g.options;n=null;l&&l.length&&(n=(l=l[g.selectedIndex])&&l.value);l=[];r=k.length;for(t=0;t<r;t++)u=k[t],l.push('\x3coption value\x3d"'),l.push(u.key),n&&n==u.key?(n=null,l.push('" selected\x3d"selected"\x3e')):l.push('"\x3e'),l.push(D(u.value)),l.push("\x3c/option\x3e");g.innerHTML=l.join("")}continue}if(a){h("No destination found for table "+s);continue}}if(c=d.getElementById(s))if(f=s,null==a&&(fieldVaue=""),g=c.tagName.toLowerCase(),"input"===g)"checkbox"===c.type.toLowerCase()?
c.checked=c.value?!0:!1:c.value=a;else if("select"===g)if(c.multiple)for(a=getVals(a),f=c.firstChild;f;)a[f.value]?c.setAttribute("selected","selected"):c.removeAttribute("selected"),f=f.nextSibling;else c.value=a;else if(c.hasAttribute("data-value"))c.setAttribute("data-value",a);else if(c.hasAttribute("data-radio"))if(c=c.getElementsByTagName("input"),c.length)for(g=c.length-1;0<=g;g--)f=c[g],f.checked=f.value==a;else h("we found tag for "+f+" as data-radio but it does not have radio child nodes");
else if(c.hasAttribute("data-checkbox"))if(a=getVals(a),c=c.getElementsByTagName("input"),c.length)for(g=c.length-1;0<=g;g--)f=c[g],f.checked=a[f.value];else h("we found tag for "+f+" but it does not have check-box child nodes");else c.textContent=a;else if(f=d.getElementById(s+"-true"),c=d.getElementById(s+"-false"),f||c)c&&(c.style.display==f?"":"none"),a&&(a.style.display==f?"none":"")}}},F=function(b){for(b=b.firstChild;b;){if(b.hasAttribute){if(b.hasAttribute(POCOL.DATA_ROW))return b;var d=F(b);
if(d)return d}b=b.nextSibling}return null},L=function(b,d,e){var a=F(b);if(!a)return p("Element "+b.id+" is marked as data-table, but it does not have a child ele marked as data-row"),null;d=null;d=[];var c=null;if(e){c=a.parentNode;c.insertBefore(document.createTextNode("___"),a);c.removeChild(a);c=b.outerHTML.split("___");if(2!=c.length)return p("we assume that you have no need to use three underscores together anywhere, but found one such instance in your html"),null;y(d,c[0]);c=c[1]}a.style.display=
"none";d.push({html:a.outerHTML});a.style.display="";d.startAt=d.length;if(b.hasAttribute(POCOL.HAS_CHILDREN)){b=d;e=a.cloneNode();e.innerHTML="___";var f=e.outerHTML.split("___");if(2!=f.length)p("Our algorithm for setting data to table assumes that your html has no triple underscores. Please remove them from your html");else{var g=[f[0]];for(e=a.firstChild;;){if(!e){g.length&&y(b,g.join(""));break}if(e.getAttribute)if(a=e.getAttribute(POCOL.DATA_TABLE)){g.length&&(y(b,g.join("")),g=[]);var h=L(e,
a,!0);b.push({child:a,parts:h})}else g.push(e.outerHTML);else g.push(e.nodeValue);e=e.nextSibling}b.push({html:f[1]})}}else y(d,a.outerHTML);d.endBefore=d.length;c&&y(d,c);return d},y=function(b,d){var e=d.split(POCOL.COL_MARKER),a=e.length;if(1!==a%2)p("We assume that you use double underscore as delimiter for marking tabl elements, like __colName__, Since this is ot true, we are unabel to set data to table.");else{b.push({html:e[0]});for(var c=1;c<a;c++){var f=e[c];f===POCOL.IDX_MARKER?b.push({id:!0}):
b.push({col:f});c++;b.push({html:e[c]})}}},M=function(b,d,e,a,c){for(var f=b.startAt,g=0;g<f;g++)a.push(G(b[g],d,c));for(var f=b.endBefore,h=e?e.length:0,n=0;n<h;n++)for(var s=e[n],l=c+"_"+n,g=b.startAt;g<f;g++){var r=b[g];r.child?M(r.parts,s,s[r.child],a,l):a.push(G(r,s,l))}f=b.length;for(g=b.endBefore;g<f;g++)a.push(G(b[g],d,c))},G=function(b,d,e){var a=b.html;if(a)return a;if(b.id)return e;a=b.col;return d&&d.hasOwnProperty(a)?K(d[a]):""},K=function(b){return b=b&&b.toLocaleDateString?b.toLocaleDateString():
D(b)},H=null,C=function(b,d,e,a){e=e||B;a=a||x;if(b){h("Service "+b+" invoked");var c=new XMLHttpRequest;c.onreadystatechange=function(){if("4"==this.readyState){var f={};if(c.responseText)try{f=JSON.parse(c.responseText)}catch(k){h("Response is not json. response text is returned instead of js object...."),f=c.responseText}if(c.status&&200!=c.status)h("HTTP error from server (non-200)\n"+c.responseText),a(q("Server or the communication infrastructure has failed to respond."));else{var n=f[POCOL.REQUEST_STATUS]||
POCOL.STATUS_OK;n==POCOL.STATUS_OK?(window[POCOL.LAST_JSON]=f,h("Json saved as "+POCOL.LAST_JSON),e(f)):n==POCOL.STATUS_NO_LOGIN?H?(h("Login required. invoking relogin"),H(b,d,e,a)):a(q("This service requires a valid login. Please login and try again.")):((f=f[POCOL.MESSAGES])||(f=q("Server reported a failure, but did not specify any error text.")),a(f))}}};c.ontimeout=function(){h("time out");a(q("Sorry, there seem to be some red-tapism on the server. giving-up"))};try{c.open("POST","a._s",!0),c.timeout=
12E3,c.setRequestHeader("Content-Type","text/html; charset\x3dutf-8"),c.setRequestHeader(POCOL.SERVICE_NAME,b),c.send(d)}catch(f){h("error during xhr : "+f.message),a(q("Unable to connect to server. Error : "+f.message))}}else h("No service"),a(q("No serviceName specified"))},q=function(b){return[{messageType:"error",text:b}]},N=function(b){var d={};d[POCOL.REQUEST_STATUS]=POCOL.STATUS_ERROR;d[POCOL.MESSAGES]=q(b);return d},I=function(){var b={};b[POCOL.REQUEST_STATUS]=POCOL.STATUS_OK;b[POCOL.MESSAGES]=
[];return b},Q=function(b,d,e,a){e=e||B;a=a||x;if(b){if(d&&d.length)try{d=JSON.parse(d)}catch(c){h("Invaid input json. Assuming that the service is a special one that expects plain text..")}else d={};h("Service "+b+" invoked locally");d=O.getResponse(b,d);h("local response for service "+b+" :");h(d);try{d=JSON.parse(d)}catch(f){h("Response is not a valid JSON. Assumed to be text and returning text instead of JSON.")}(b=d[POCOL.REQUEST_STATUS])&&b!=POCOL.STATUS_OK?((e=d[POCOL.MESSAGES])||(e=q("Server indicated failure of service, but offered no explanation!")),
a(e)):(window[POCOL.LAST_JSON]=d,e(d))}else h("No service"),FailureFn(q("No serviceName specified"))},P=function(b,d,e,a,c){if(b){var f=new XMLHttpRequest;f.onloadend=function(){var c=null;f.status&&200!=f.status?(h("non 200 status : "+f.status),a(null)):c=f.response;a?a(c,d,e):Simplity.message("We successfully downloaded file for key "+b+" with content-type\x3d"+f.getResponseHeader("Content-Type")+" and total size of "+f.getResponseHeader("Content-Length"))};f.ontimeout=function(){h("file download timed out");
a(null)};c&&(f.onprogress=function(b){b.lengthComputable&&(b=Math.round(100*b.loaded/b.total),c(b))});try{f.open("GET","a._f?"+b,!0);if(d||e)f.responseType="blob";f.send()}catch(g){p("error during xhr for downloading token : "+b+". error :"+g)}}else p("No file token specified for download request")},R=function(){},O=function(){var b={tables:{},views:{},responses:{}},d=function(b,a,c){a||(a={});if(c)for(var d=0;d<c.length;d++){var f=c[d];b.hasOwnProperty(f)&&(a[f]=b[f])}else for(d in b)a[d]=b[d];return a},
e=function(b,a,c){for(var d=[],f=b&&b.length||0,e=0;e<f;e++){var g=b[e];g[a]==c&&d.push(g)}return d},a=function(b,a){var c=b[a.name];switch(a.op){case "\x3d":return a.value==c;case "!\x3d":return a.value!=c;case "\x3c":return c<a.value;case "\x3c\x3d":return a.value<=c;case "\x3e":return c>a.value;case "\x3e\x3d":return a.value>=c;case "\x3e\x3c":return c>a.value&&c<a.to;case "^":return 0==c.toUpperCase().indexOf(a.value.toUpperCase());case "~":return-1!=c.toUpperCase().indexOf(a.value.toUpperCase());
case "@":for(var d=a.value&&a.value.split(","),f=d.length||0,e=0;e<f;e++)if(c==d[e])return!0;return!1}},c=function(b,c){for(var d=[],f=b.length||0,e=c.length||0,g=0;g<f;g++){for(var h=b[g],v=!0,m=0;m<e;m++)if(!a(h,c[m])){v=!1;break}v&&d.push(h)}return d},f=function(a,g,l,r,t){var u=b.tables[a];if(!u)throw a+" is not defined as a table/view under _localData";t=t&&u.children;h("getting data for table "+a+" with children \x3d "+t);for(var k={},v=[],m=null;;){m=b.tables[a];if(!m)throw a+" is not defined as a table/view under _localData";
if(m.data)break;k[a]=!0;v.push(m);a=m.baseTable;if(k[a])throw"We found cyclic dependence of table "+a;}a=m.data;g?a=e(a,m.key,g[m.key]):l&&(a=e(a,l,r));g=a&&a.length||0;l=[];for(r=0;r<g;r++)l.push(d(a[r]));a=l;if(!a||!a.length)return a;for(g=v.length-1;0<=g;g--)if(l=v[g].joins,r=a,m=r.length||0,k=l.length||0,m&&k)for(var q=0;q<m;q++)for(var p=r[q],x=0;x<k;x++){var z=l[x],w=z.baseField;if(!p.hasOwnProperty(w))throw"base table does not have the attribute "+w+". Invalid join specification.";var y=f(z.joinedTable,
null,z.joinedField,p[w],!1);if(1<y.length)throw"We got "+y.length+" items as children from "+z.joinedTable+" with its parent key field "+z.joinedFeild+" \x3d "+p[z.fieldName]+" but the join definition has not specified childrenName indicating that we do not expect more than one child items.";y.length?d(y[0],p):h("No row from joining table "+z.joinedTable+" with  "+z.joinedField+" \x3d "+p[w])}if(!t)return a;h("going to add rows from children "+t);v=a.length;u=u.key;l={name:u,op:"\x3d"};r=[l];for(g=
0;g<t.length;g++)for(m=t[g],k=f(m,null,null,null,!0),q=0;q<v;q++)p=a[q],l.value=p[u],p[m]=c(k,r);return a},g={get:function(a,b){var c=f(a,b,null,null,!0),e=I();(c=c&&c[0])&&d(c,e);return e},filter:function(a,b){var d=f(a,null,null,null,!0);if(d.length&&b){var e=d[0],g=[];for(fieldName in e)if(b.hasOwnProperty(fieldName)){e={name:fieldName,value:b[fieldName],op:"\x3d"};g.push(e);var h=b[fieldName+"Operator"];if(h&&(e.op=h,"\x3e\x3c"==h)){h=b[fieldName+"To"];if(!h)throw"we expected a value for "+fieldName+
"To because the operator is between (\x3e\x3c)";e.to=h}}g.length&&(d=c(d,g))}g=I();g[a]=d;return g},save:function(a,c){var d=b.tables[a];if(!d)throw a+" is not a table and hence data can not be saved using an express service";var f=d.key,e=c[f],d=d.data,g=null;if(e){a:{for(var h=d.length,g=0;g<h;g++){var k=d[g];if(k[f]==e){g=k;break a}}g=null}if(!g)throw"Item not found for the supplied key. Data can not be saved.";}h={};k=d[0];g||(g={});for(var m in k)c.hasOwnProperty(m)&&(g[m]=c[m]);e||(e=d[d.length-
1][f],e++,g[f]=e,d.push(g),h[f]=e);return h},"delete":function(a,c){var d=b.tables[a];if(!d)throw a+" is not a valid table name";return deleteData(d,c)},list:function(a,c){var d=b.tables[a];if(!d)throw a+" is not a table and hence we are unable to get a list of vname-value pairs";var f=d.key,e=d.valueFieldName;if(!f||!e)throw a+" need to have attributes key and valueFieldName for us to create a list of name-value pairs";for(var g=[],d=d.data,h=d.length,k=0;k<h;k++){var m=d[k];g.push({key:m[f],value:m[e]})}f=
I();f[a]=g;return f},suggest:function(a,b){return N("local functionaity for suggest is not yet built")}},k=function(a,d){var c=window[POCOL.LOCAL_RESPONSES];if(c=c&&c[a])return h("response located in page-specific response"),c;if(c=(c=window[POCOL.LOCAL_SERVICES])&&c[a]){h("service function found in page-specific script");if("function"!==typeof c)throw c+" is expected to be a function that returns a valid response to a request for service "+a;return c(d)}if(c=b.responses[a])return h("response located in local ready-responses"),
c;c=a.split("_");if(1<c.length){var c=c[0],f=g[c];if(f){var e=a.substring(c.length+1);h("trying "+c+" for table "+e);return f(e,d)}}throw a+" is not served by the local server.";};return{initialize:function(a){b=a},getResponse:function(a,b){var c=null;try{c=k(a,b)}catch(d){c=N(d.message?d.message:d)}return JSON.stringify(c)}}}(),w=null;if("file:"===window.location.protocol){if(C=sessionStorage[POCOL.LOCAL_STORAGE_NAME])h("Session storage found in session"),w=JSON.parse(C);else if(w=window[POCOL.LOCAL_STORAGE_NAME])h("local storage found as windows variable.."),
sessionStorage[POCOL.LOCAL_STORAGE_NAME]=JSON.stringify(w);w?(O.initialize(w),window.addEventListener("beforeunload",function(){sessionStorage[POCOL.LOCAL_STORAGE_NAME]=JSON.stringify(w)})):h("local storage NOT found");C=Q}return{log:h,error:p,warn:J,pipeLogging:function(b,d,e){b&&d?(p=b,J=warningFn,e&&(h=e)):reportError("You need to specify both errorFn and warningFn for re-plumbing logging with pipeLogging() method")},showMessage:E,showMessages:x,overrideShowMessage:function(b){E=b},overrideShowMessages:function(b){x=
b},getResponse:C,login:function(b,d,e,a){e=e||B;a=a||x;var c=new XMLHttpRequest;c.onreadystatechange=function(){if("4"==this.readyState){var b={};c.responseText&&(b=JSON.parse(c.responseText));c.status&&200!=c.status?(h("HTTP error from server (non-200)\n"+c.responseText),a(q("Server or the communication infrastructure has failed to respond."))):(b[POCOL.REQUEST_STATUS]||POCOL.STATUS_OK)==POCOL.STATUS_OK?e(b):b[POCOL.MESSAGES]?a(b[POCOL.MESSAGES]):a(q("Login failed"))}};c.ontimeout=function(){a(q("Sorry, there seem to be some red-tapism on the server. Can't wait any more for a decision. Giving up."))};
try{c.open("POST","a._i",!0),c.timeout=12E3,c.setRequestHeader("Content-Type","text/html; charset\x3dutf-8"),d&&(b+=" "+d),c.setRequestHeader(POCOL.USER_TOKEN,b),c.send("")}catch(f){a(q("Unable to connect to server. Error : "+f.message))}},logout:function(){var b=new XMLHttpRequest;try{b.open("POST","a._o",!0),b.setRequestHeader("Content-Type","text/html; charset\x3dutf-8"),b.send("")}catch(d){x(q("Unable to connect to server. Error : "+d))}},pushDataToPage:B,uploadFile:function(b,d,e){h("File "+
b.name+" of mime-type "+b.mime+" of size "+b.size+" is being uploaded");d||p("No callback funciton. We will set window._uploadedFileKey to the returned key");var a=new XMLHttpRequest;a.onreadystatechange=function(){if("4"==this.readyState){var b=null;a.status&&200!=a.status?h("File upload failed with non 200 status : "+a.status):b=a.getResponseHeader(POCOL.FILE_TOKEN);d?d(b):window._uploadedFileKey=b}};a.ontimeout=function(){h("file upload timed out");d&&d(null)};e&&(a.upload.onprogress=function(a){a.lengthComputable&&
(a=Math.round(100*a.loaded/a.total),e(a))});try{a.open("POST","a._f",!0),a.timeout=12E3,a.setRequestHeader(POCOL.FILE_NAME,b.name),h("header field "+POCOL.FILE_NAME+"\x3d"+b.name),b.mime&&(a.setRequestHeader(POCOL.MIME_TYPE,b.mime),h("header field "+POCOL.MIME_TYPE+"\x3d"+b.mime)),a.send(b)}catch(c){p("error during xhr : "+c),d&&d(null)}},discardFile:function(b){if(b){var d=new XMLHttpRequest;try{d.open("POST","a._f",!0),d.setRequestHeader(POCOL.FILE_TOKEN,b),d.setRequestHeader(POCOL.SERVICE_NAME,
POCOL.DISCARD),d.send()}catch(e){p("error during xhr for discarding token : "+b+". error :"+e)}}else p("No file token specified for discard request")},downloadFile:P,registerRelogin:function(b){H=b},getLogs:function(b){b=b||R;P(POCOL.FILE_NAME_FOR_LOGS,null,null,b)},htmlEscape:D,downloadCsv:function(b){if(Array.isArray(b)){for(var d="",e=0;e<b.length;e++){var a="",c;for(c in b[e])a+='"'+b[e][c]+'",';a.slice(0,a.length-1);d+=a+"\r\n"}for(e=0;e<b.length;e++){a="";for(c in b[e])a+='"'+b[e][c]+'",';a.slice(0,
a.length-1);d+=a+"\r\n"}""==d?alert("Invalid data"):(b="data:text/csv;charset\x3dutf-8,"+escape(d),d=document.createElement("a"),d.href=b,d.style="visibility:hidden",d.download="download.csv",document.body.appendChild(d),d.click(),document.body.removeChild(d))}else h("Simplity function downloadCsv() requires that the json to be an array. Data not pushed to page")}}}();